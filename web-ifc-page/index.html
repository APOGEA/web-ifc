<body>
    <input type="file"
       id="finput">
</body>


<script src="web-ifc.js"></script>

<script>

    function hugeString()
    {
        let str = "aaaaaa;aaa";
        let total = "";
        for (let i = 0; i < 1000_0000; i++)
        {
            total += str;
        }
        console.log(total.length);
        return total;
    }

    let fileInput = document.getElementById("finput");

    console.log(Module);
    Module["onRuntimeInitialized"] = () => {
        // let jsString = "hugeString()";
        // var lengthBytes = lengthBytesUTF8(jsString)+1;
        // var stringOnWasmHeap = _malloc(lengthBytes);
        // stringToUTF8(jsString, stringOnWasmHeap, lengthBytes);
        // console.log(lengthBytes);

        // var result = Module.ccall('functionCall', // name of C function
        // 'void', // return type
        // ["string"], // argument types
        // [stringOnWasmHeap]); // arguments
        // _free(stringOnWasmHeap);

        // Module.functionCall(hugeString());

        fileInput.addEventListener('change', () => {
            console.log("change");
            if (fileInput.files.length == 0)
                return;
            var file = fileInput.files[0];

            var fr = new FileReader();
            fr.onload = function () {
                var data = new Uint8Array(fr.result);

                // let str = hugeString();
                // var enc = new TextEncoder(); 
                // var data = enc.encode(str);
                var data = new Uint8Array(fr.result);
                Module['FS_createDataFile']('/', 'filename', data, true, true, true);

                let start = new Date().getTime();
                console.log("Result: " + Module._functionCall());
                let end = new Date().getTime();
                console.log(`Took ${end-start}ms`);

                fileInput.value = '';
            };
            fr.readAsArrayBuffer(file);
        });
    };
    console.time();
</script>